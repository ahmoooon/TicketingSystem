<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileMovieRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">infrastructure.repositories</a> &gt; <span class="el_source">FileMovieRepository.java</span></div><h1>FileMovieRepository.java</h1><pre class="source lang-java linenums">package infrastructure.repositories;

import application.utilities.LoggerSetup;
import domain.Movie;
import domain.repositories.MovieRepository;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.stream.Collectors;

public class FileMovieRepository implements MovieRepository {
    
    private static final String MOVIE_FILE = &quot;movies.json&quot;;
<span class="nc" id="L17">    private static final Logger logger = LoggerSetup.getLogger();</span>
    
    private List&lt;Movie&gt; movieList;

<span class="nc" id="L21">    public FileMovieRepository() {</span>
<span class="nc" id="L22">        loadData();</span>
        // --- ADD DEBUG LINE 1 HERE ---
<span class="nc bnc" id="L24" title="All 2 branches missed.">        System.out.println(&quot;[DEBUG] Movies loaded from file: &quot; + (movieList != null ? movieList.size() : 0)); </span>
<span class="nc" id="L25">    }</span>

    private void loadData() {
<span class="nc" id="L28">        List&lt;String&gt; jsonLines = DataFileHandler.loadFromJsonFile(MOVIE_FILE);</span>
        
<span class="nc bnc" id="L30" title="All 2 branches missed.">        if (jsonLines.isEmpty()) {</span>
            // --- ADD DEBUG LINE 2 HERE ---
<span class="nc" id="L32">            System.out.println(&quot;[DEBUG] List is empty. Seeding default data...&quot;);</span>
            
<span class="nc" id="L34">            logger.warning(&quot;No movies found in file. Creating default movies.&quot;);</span>
<span class="nc" id="L35">            movieList = createDefaultMovies();</span>
<span class="nc" id="L36">            saveMovies(); </span>
        } else {
<span class="nc" id="L38">            movieList = jsonLines.stream()</span>
<span class="nc" id="L39">                .map(this::parseMovieFromJson)</span>
<span class="nc bnc" id="L40" title="All 2 branches missed.">                .filter(m -&gt; m != null)</span>
<span class="nc" id="L41">                .collect(Collectors.toList());</span>
        }
        
<span class="nc" id="L44">        logger.log(Level.INFO, &quot;Loaded {0} movies from {1}&quot;, </span>
<span class="nc" id="L45">                   new Object[]{movieList.size(), MOVIE_FILE});</span>
<span class="nc" id="L46">    }</span>
    
    // ... (Keep the rest of the methods extractInt, extractString etc. exactly the same) ...

    private Movie parseMovieFromJson(String json) {
        try {
<span class="nc" id="L52">            int id = extractInt(json, &quot;id&quot;);</span>
<span class="nc" id="L53">            String movieName = extractString(json, &quot;movieName&quot;);</span>
<span class="nc" id="L54">            double movieLength = extractDouble(json, &quot;movieLength&quot;);</span>
<span class="nc" id="L55">            String director = extractString(json, &quot;director&quot;);</span>
<span class="nc" id="L56">            String releaseDate = extractString(json, &quot;releaseDate&quot;);</span>
            
<span class="nc" id="L58">            return new Movie(id, movieName, movieLength, director, releaseDate);</span>
            
<span class="nc" id="L60">        } catch (Exception e) {</span>
<span class="nc" id="L61">            logger.log(Level.SEVERE, &quot;Failed to parse movie JSON: {0}. Error: {1}&quot;, </span>
<span class="nc" id="L62">                        new Object[]{json, e.getMessage()});</span>
<span class="nc" id="L63">            return null;</span>
        }
    }
    
    private List&lt;Movie&gt; createDefaultMovies() {
<span class="nc" id="L68">        List&lt;Movie&gt; defaults = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L69">        defaults.add(new Movie(1, &quot;Dune: Part 1&quot;, 2.35, &quot;Denis Villeneuve&quot;, &quot;October 22, 2021&quot;));</span>
<span class="nc" id="L70">        defaults.add(new Movie(2, &quot;Blade Runner 2049&quot;, 2.43, &quot;Denis Villeneuve&quot;, &quot;October 5, 2017&quot;));</span>
<span class="nc" id="L71">        defaults.add(new Movie(3, &quot;Infinity Pool&quot;, 1.58, &quot;Brandon Cronenberg&quot;, &quot;January 27, 2023&quot;));</span>
<span class="nc" id="L72">        defaults.add(new Movie(4, &quot;Crimes of the Future&quot;, 1.47, &quot;David Cronenberg&quot;, &quot;May 25, 2022&quot;));</span>
<span class="nc" id="L73">        defaults.add(new Movie(5, &quot;Asteroid City&quot;, 1.45, &quot;Wes Anderson&quot;, &quot;June 15, 2023&quot;));</span>
<span class="nc" id="L74">        return defaults;</span>
    }
    
    private void saveMovies() {
<span class="nc" id="L78">        List&lt;String&gt; jsonLines = movieList.stream()</span>
<span class="nc" id="L79">            .map(this::movieToJsonString)</span>
<span class="nc" id="L80">            .collect(Collectors.toList());</span>
        
<span class="nc" id="L82">        DataFileHandler.saveToJsonFile(jsonLines, MOVIE_FILE);</span>
<span class="nc" id="L83">    }</span>
    
    private String movieToJsonString(Movie movie) {
<span class="nc" id="L86">        return String.format(</span>
            &quot;{\&quot;id\&quot;:%d,\&quot;movieName\&quot;:\&quot;%s\&quot;,\&quot;movieLength\&quot;:%.2f,\&quot;director\&quot;:\&quot;%s\&quot;,\&quot;releaseDate\&quot;:\&quot;%s\&quot;}&quot;,
<span class="nc" id="L88">            movie.getId(),</span>
<span class="nc" id="L89">            movie.getMovieName(),</span>
<span class="nc" id="L90">            movie.getMovieLength(),</span>
<span class="nc" id="L91">            movie.getDirector(),</span>
<span class="nc" id="L92">            movie.releaseDate()</span>
        );
    }
    
    @Override
    public List&lt;Movie&gt; findAll() {
<span class="nc" id="L98">        return new ArrayList&lt;&gt;(movieList);</span>
    }

    @Override
    public Optional&lt;Movie&gt; findById(int id) {
<span class="nc" id="L103">        return movieList.stream()</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">                .filter(m -&gt; m.getId() == id)</span>
<span class="nc" id="L105">                .findFirst();</span>
    }
    
    private int extractInt(String json, String key) {
<span class="nc" id="L109">        String searchKey = &quot;\&quot;&quot; + key + &quot;\&quot;:&quot;;</span>
<span class="nc" id="L110">        int start = json.indexOf(searchKey) + searchKey.length();</span>
<span class="nc" id="L111">        int end = json.indexOf(&quot;,&quot;, start);</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">        if (end == -1) end = json.indexOf(&quot;}&quot;, start);</span>
<span class="nc" id="L113">        return Integer.parseInt(json.substring(start, end).trim());</span>
    }
    
    private double extractDouble(String json, String key) {
<span class="nc" id="L117">        String searchKey = &quot;\&quot;&quot; + key + &quot;\&quot;:&quot;;</span>
<span class="nc" id="L118">        int start = json.indexOf(searchKey) + searchKey.length();</span>
<span class="nc" id="L119">        int end = json.indexOf(&quot;,&quot;, start);</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (end == -1) end = json.indexOf(&quot;}&quot;, start);</span>
<span class="nc" id="L121">        return Double.parseDouble(json.substring(start, end).trim());</span>
    }
    
    private String extractString(String json, String key) {
<span class="nc" id="L125">        String searchKey = &quot;\&quot;&quot; + key + &quot;\&quot;:\&quot;&quot;;</span>
<span class="nc" id="L126">        int start = json.indexOf(searchKey) + searchKey.length();</span>
<span class="nc" id="L127">        int end = json.indexOf(&quot;\&quot;&quot;, start);</span>
<span class="nc" id="L128">        return json.substring(start, end);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>