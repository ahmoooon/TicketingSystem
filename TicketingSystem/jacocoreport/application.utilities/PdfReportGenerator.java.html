<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PdfReportGenerator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">application.utilities</a> &gt; <span class="el_source">PdfReportGenerator.java</span></div><h1>PdfReportGenerator.java</h1><pre class="source lang-java linenums">package application.utilities;

import org.apache.pdfbox.pdmodel.PDDocument;
import org.apache.pdfbox.pdmodel.PDPage;
import org.apache.pdfbox.pdmodel.PDPageContentStream;
import org.apache.pdfbox.pdmodel.common.PDRectangle;
import org.apache.pdfbox.pdmodel.font.PDType1Font;
import org.apache.pdfbox.pdmodel.font.Standard14Fonts;

import java.io.File;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;

/**
 * Utility class for generating PDF reports from text content.
 * Uses Apache PDFBox library for PDF generation.
 */
<span class="nc" id="L23">public class PdfReportGenerator {</span>
    
<span class="nc" id="L25">    private static final Logger logger = LoggerSetup.getLogger();</span>
    
    // PDF Layout Constants
    private static final float MARGIN = 50;
    private static final float FONT_SIZE_TITLE = 16;
    private static final float FONT_SIZE_NORMAL = 10;
    private static final float LINE_HEIGHT = 15;
    private static final int MAX_CHARS_PER_LINE = 85;
    
    // Static initializer to disable font cache and suppress warnings
    static {
        try {
            // Disable PDFBox font cache to avoid corrupted font issues
<span class="nc" id="L38">            System.setProperty(&quot;pdfbox.fontcache&quot;, &quot;false&quot;);</span>
            
            // Disable system font loading entirely - use only PDF base fonts
<span class="nc" id="L41">            System.setProperty(&quot;sun.font.fontmanager&quot;, &quot;sun.awt.X11FontManager&quot;);</span>
            
            // Suppress PDFBox font warnings
<span class="nc" id="L44">            Logger pdfboxLogger = Logger.getLogger(&quot;org.apache.fontbox&quot;);</span>
<span class="nc" id="L45">            pdfboxLogger.setLevel(Level.SEVERE); // Only show severe errors</span>
            
<span class="nc" id="L47">            Logger pdfboxTTFLogger = Logger.getLogger(&quot;org.apache.fontbox.ttf&quot;);</span>
<span class="nc" id="L48">            pdfboxTTFLogger.setLevel(Level.SEVERE);</span>
            
<span class="nc" id="L50">            Logger pdfboxTTFParser = Logger.getLogger(&quot;org.apache.fontbox.ttf.TTFParser&quot;);</span>
<span class="nc" id="L51">            pdfboxTTFParser.setLevel(Level.SEVERE);</span>
<span class="nc" id="L52">        } catch (Exception e) {</span>
            // Ignore any errors in static initialization
<span class="nc" id="L54">            System.err.println(&quot;Warning: Could not configure PDF font settings: &quot; + e.getMessage());</span>
<span class="nc" id="L55">        }</span>
<span class="nc" id="L56">    }</span>
    
    /**
     * Generates a PDF report from text content and saves it to the specified file.
     * 
     * @param reportContent The text content of the report
     * @param outputFile The file where the PDF should be saved
     * @param reportTitle The title of the report
     * @throws IOException if PDF generation or file writing fails
     */
    public static void generatePdfReport(String reportContent, File outputFile, String reportTitle) 
            throws IOException {
        
<span class="nc" id="L69">        logger.info(&quot;Generating PDF report: &quot; + reportTitle);</span>
        
<span class="nc" id="L71">        try (PDDocument document = new PDDocument()) {</span>
            // Split content into lines
<span class="nc" id="L73">            List&lt;String&gt; lines = splitIntoLines(reportContent);</span>
            
<span class="nc" id="L75">            PDPage page = new PDPage(PDRectangle.A4);</span>
<span class="nc" id="L76">            document.addPage(page);</span>
            
<span class="nc" id="L78">            try (PDPageContentStream contentStream = new PDPageContentStream(document, page)) {</span>
                
                // Current Y position (starts from top)
<span class="nc" id="L81">                float yPosition = page.getMediaBox().getHeight() - MARGIN;</span>
                
                // Write header
<span class="nc" id="L84">                yPosition = writeHeader(contentStream, page, reportTitle, yPosition);</span>
                
                // Write content
<span class="nc" id="L87">                writeContent(document, contentStream, page, lines, yPosition);</span>
            }
            
            // Save document
<span class="nc" id="L91">            document.save(outputFile);</span>
<span class="nc" id="L92">            logger.info(&quot;PDF report saved successfully: &quot; + outputFile.getAbsolutePath());</span>
            
<span class="nc" id="L94">        } catch (IOException e) {</span>
<span class="nc" id="L95">            logger.log(Level.SEVERE, &quot;Failed to generate PDF report&quot;, e);</span>
<span class="nc" id="L96">            throw e;</span>
<span class="nc" id="L97">        }</span>
<span class="nc" id="L98">    }</span>
    
    /**
     * Writes the report header (title and date).
     */
    private static float writeHeader(PDPageContentStream contentStream, PDPage page, 
                                     String title, float yPosition) throws IOException {
        
        // Company name
<span class="nc" id="L107">        contentStream.beginText();</span>
<span class="nc" id="L108">        contentStream.setFont(new PDType1Font(Standard14Fonts.FontName.HELVETICA_BOLD), FONT_SIZE_TITLE);</span>
<span class="nc" id="L109">        contentStream.newLineAtOffset(MARGIN, yPosition);</span>
<span class="nc" id="L110">        contentStream.showText(&quot;YSCM CINEMA - &quot; + title);</span>
<span class="nc" id="L111">        contentStream.endText();</span>
        
<span class="nc" id="L113">        yPosition -= LINE_HEIGHT * 1.5f;</span>
        
        // Date
<span class="nc" id="L116">        SimpleDateFormat dateFormat = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span>
<span class="nc" id="L117">        String currentDate = dateFormat.format(new Date());</span>
        
<span class="nc" id="L119">        contentStream.beginText();</span>
<span class="nc" id="L120">        contentStream.setFont(new PDType1Font(Standard14Fonts.FontName.HELVETICA), FONT_SIZE_NORMAL);</span>
<span class="nc" id="L121">        contentStream.newLineAtOffset(MARGIN, yPosition);</span>
<span class="nc" id="L122">        contentStream.showText(&quot;Generated: &quot; + currentDate);</span>
<span class="nc" id="L123">        contentStream.endText();</span>
        
<span class="nc" id="L125">        yPosition -= LINE_HEIGHT * 2;</span>
        
        // Separator line
<span class="nc" id="L128">        contentStream.moveTo(MARGIN, yPosition);</span>
<span class="nc" id="L129">        contentStream.lineTo(page.getMediaBox().getWidth() - MARGIN, yPosition);</span>
<span class="nc" id="L130">        contentStream.stroke();</span>
        
<span class="nc" id="L132">        yPosition -= LINE_HEIGHT;</span>
        
<span class="nc" id="L134">        return yPosition;</span>
    }
    
    /**
     * Writes the main report content, handling page breaks.
     */
    private static float writeContent(PDDocument document, PDPageContentStream contentStream,
                                     PDPage currentPage, List&lt;String&gt; lines, float yPosition) 
            throws IOException {
        
<span class="nc" id="L144">        contentStream.setFont(new PDType1Font(Standard14Fonts.FontName.COURIER), FONT_SIZE_NORMAL);</span>
        
<span class="nc bnc" id="L146" title="All 2 branches missed.">        for (String line : lines) {</span>
            // Check if we need a new page
<span class="nc bnc" id="L148" title="All 2 branches missed.">            if (yPosition &lt; MARGIN + LINE_HEIGHT) {</span>
                // Close current content stream properly
<span class="nc" id="L150">                contentStream.close();</span>
                
<span class="nc" id="L152">                currentPage = new PDPage(PDRectangle.A4);</span>
<span class="nc" id="L153">                document.addPage(currentPage);</span>
                
<span class="nc" id="L155">                PDPageContentStream newContentStream = new PDPageContentStream(document, currentPage);</span>
<span class="nc" id="L156">                newContentStream.setFont(new PDType1Font(Standard14Fonts.FontName.COURIER), FONT_SIZE_NORMAL);</span>
                
<span class="nc" id="L158">                yPosition = currentPage.getMediaBox().getHeight() - MARGIN;</span>
                
                // Write remaining lines on new page
<span class="nc" id="L161">                return writeContentContinued(newContentStream, lines, lines.indexOf(line), yPosition);</span>
            }
            
            // Write line - ensure text block is properly closed
<span class="nc" id="L165">            contentStream.beginText();</span>
<span class="nc" id="L166">            contentStream.newLineAtOffset(MARGIN, yPosition);</span>
            try {
<span class="nc" id="L168">                contentStream.showText(line);</span>
<span class="nc" id="L169">            } catch (IllegalArgumentException e) {</span>
                // If character encoding fails, log and skip this line
<span class="nc" id="L171">                logger.log(Level.WARNING, &quot;Skipping line due to encoding error: {0}&quot;, e.getMessage());</span>
<span class="nc" id="L172">                contentStream.showText(&quot;[Content contains unsupported characters]&quot;);</span>
<span class="nc" id="L173">            }</span>
<span class="nc" id="L174">            contentStream.endText();</span>
            
<span class="nc" id="L176">            yPosition -= LINE_HEIGHT;</span>
<span class="nc" id="L177">        }</span>
        
<span class="nc" id="L179">        return yPosition;</span>
    }
    
    /**
     * Helper method to continue writing content on new page
     */
    private static float writeContentContinued(PDPageContentStream contentStream, 
                                              List&lt;String&gt; lines, int startIndex, float yPosition) 
            throws IOException {
        
<span class="nc bnc" id="L189" title="All 2 branches missed.">        for (int i = startIndex; i &lt; lines.size(); i++) {</span>
<span class="nc" id="L190">            String line = lines.get(i);</span>
            
            // Check if we need another new page
<span class="nc bnc" id="L193" title="All 2 branches missed.">            if (yPosition &lt; MARGIN + LINE_HEIGHT) {</span>
                // We would need to recursively handle pagination here
                // For simplicity, just stop (or you could implement full recursion)
<span class="nc" id="L196">                break;</span>
            }
            
<span class="nc" id="L199">            contentStream.beginText();</span>
<span class="nc" id="L200">            contentStream.newLineAtOffset(MARGIN, yPosition);</span>
            try {
<span class="nc" id="L202">                contentStream.showText(line);</span>
<span class="nc" id="L203">            } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L204">                logger.log(Level.WARNING, &quot;Skipping line due to encoding error: {0}&quot;, e.getMessage());</span>
<span class="nc" id="L205">                contentStream.showText(&quot;[Content contains unsupported characters]&quot;);</span>
<span class="nc" id="L206">            }</span>
<span class="nc" id="L207">            contentStream.endText();</span>
            
<span class="nc" id="L209">            yPosition -= LINE_HEIGHT;</span>
        }
        
<span class="nc" id="L212">        return yPosition;</span>
    }
    
    /**
     * Splits text content into lines suitable for PDF rendering.
     * Also sanitizes content by removing unsupported characters.
     */
    private static List&lt;String&gt; splitIntoLines(String content) {
<span class="nc" id="L220">        List&lt;String&gt; lines = new ArrayList&lt;&gt;();</span>
        
        // CRITICAL: Sanitize content first - remove tabs and other control characters
<span class="nc" id="L223">        content = sanitizeTextForPdf(content);</span>
        
<span class="nc" id="L225">        String[] rawLines = content.split(&quot;\n&quot;);</span>
        
<span class="nc bnc" id="L227" title="All 2 branches missed.">        for (String rawLine : rawLines) {</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">            if (rawLine.length() &lt;= MAX_CHARS_PER_LINE) {</span>
<span class="nc" id="L229">                lines.add(rawLine);</span>
            } else {
                // Wrap long lines
<span class="nc" id="L232">                int start = 0;</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">                while (start &lt; rawLine.length()) {</span>
<span class="nc" id="L234">                    int end = Math.min(start + MAX_CHARS_PER_LINE, rawLine.length());</span>
<span class="nc" id="L235">                    lines.add(rawLine.substring(start, end));</span>
<span class="nc" id="L236">                    start = end;</span>
<span class="nc" id="L237">                }</span>
            }
        }
        
<span class="nc" id="L241">        return lines;</span>
    }
    
    /**
     * Sanitizes text content to remove characters not supported by PDF fonts.
     * Replaces tabs with spaces and removes other control characters.
     * 
     * @param text The text to sanitize
     * @return Sanitized text safe for PDF rendering
     */
    private static String sanitizeTextForPdf(String text) {
<span class="nc bnc" id="L252" title="All 2 branches missed.">        if (text == null) {</span>
<span class="nc" id="L253">            return &quot;&quot;;</span>
        }
        
        // Replace tabs with 4 spaces
<span class="nc" id="L257">        text = text.replace(&quot;\t&quot;, &quot;    &quot;);</span>
        
        // Remove carriage returns (keep only line feeds)
<span class="nc" id="L260">        text = text.replace(&quot;\r&quot;, &quot;&quot;);</span>
        
        // Remove other control characters except newline (U+000A)
        // This regex removes characters in ranges:
        // U+0000-U+0009 (NULL to TAB)
        // U+000B-U+001F (vertical tab to unit separator)
        // U+007F (DELETE)
<span class="nc" id="L267">        text = text.replaceAll(&quot;[\\u0000-\\u0009\\u000B-\\u001F\\u007F]&quot;, &quot;&quot;);</span>
        
        // Replace characters outside WinAnsiEncoding range (U+0000 to U+00FF)
        // with ASCII equivalents or remove them
<span class="nc" id="L271">        StringBuilder sanitized = new StringBuilder();</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">        for (char c : text.toCharArray()) {</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">            if (c == '\n') {</span>
                // Keep newlines
<span class="nc" id="L275">                sanitized.append(c);</span>
<span class="nc bnc" id="L276" title="All 4 branches missed.">            } else if (c &gt;= 32 &amp;&amp; c &lt;= 126) {</span>
                // Standard ASCII printable characters (safe for WinAnsiEncoding)
<span class="nc" id="L278">                sanitized.append(c);</span>
<span class="nc bnc" id="L279" title="All 4 branches missed.">            } else if (c &gt;= 160 &amp;&amp; c &lt;= 255) {</span>
                // Extended ASCII (part of WinAnsiEncoding) - keep them
<span class="nc" id="L281">                sanitized.append(c);</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">            } else if (c &gt; 255) {</span>
                // Unicode characters beyond WinAnsiEncoding - replace with ?
<span class="nc" id="L284">                sanitized.append('?');</span>
            }
            // Characters &lt; 32 (except newline) are already filtered above
        }
        
<span class="nc" id="L289">        return sanitized.toString();</span>
    }
    
    /**
     * Validates that the output file path is writable.
     */
    public static boolean validateOutputPath(File outputFile) {
        try {
<span class="nc" id="L297">            File parentDir = outputFile.getParentFile();</span>
<span class="nc bnc" id="L298" title="All 4 branches missed.">            if (parentDir != null &amp;&amp; !parentDir.exists()) {</span>
<span class="nc" id="L299">                return parentDir.mkdirs();</span>
            }
<span class="nc" id="L301">            return true;</span>
<span class="nc" id="L302">        } catch (SecurityException e) {</span>
<span class="nc" id="L303">            logger.log(Level.WARNING, &quot;Cannot write to path: &quot; + outputFile.getAbsolutePath(), e);</span>
<span class="nc" id="L304">            return false;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>