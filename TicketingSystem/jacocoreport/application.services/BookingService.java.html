<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BookingService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">application.services</a> &gt; <span class="el_source">BookingService.java</span></div><h1>BookingService.java</h1><pre class="source lang-java linenums">package application.services;

import application.dto.BookingRequest;
import application.dto.BookingResult;
import domain.CinemaHall;
import domain.Movie;
import domain.Showtime;
import domain.repositories.MovieRepository;
import domain.repositories.ShowtimeRepository;
import domain.repositories.SeatRepository;
import infrastructure.repositories.FileSeatRepository;
import infrastructure.repositories.SeatUnavailableException;

import java.time.LocalDate;
import java.util.List;
import domain.Seat;

public class BookingService {
    
    private final MovieRepository movieRepository;
    private final ShowtimeRepository showtimeRepository;
    private final SeatRepository seatRepository;

    public BookingService(MovieRepository movieRepository, 
                          ShowtimeRepository showtimeRepository, 
<span class="fc" id="L26">                          SeatRepository seatRepository) {</span>
<span class="fc" id="L27">        this.movieRepository = movieRepository;</span>
<span class="fc" id="L28">        this.showtimeRepository = showtimeRepository;</span>
<span class="fc" id="L29">        this.seatRepository = seatRepository;</span>
<span class="fc" id="L30">    }</span>
    
    /**
     * The core use case: Orchestrates movie, showtime, and seat reservation.
     */
    public BookingResult bookTickets(BookingRequest request) {
        // 1. Validation
<span class="fc" id="L37">        validateBookingRequest(request);</span>
        
        // 2. Get Movie
<span class="fc" id="L40">        Movie movie = movieRepository.findById(request.getMovieId())</span>
<span class="fc" id="L41">            .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Movie with ID &quot; + request.getMovieId() + &quot; not found.&quot;));</span>
        
        // 3. Get Showtime
<span class="fc" id="L44">        Showtime showtime = showtimeRepository.findAvailableShowtime(</span>
            movie,
<span class="fc" id="L46">            request.getDate(), </span>
<span class="fc" id="L47">            request.getShowtimeTime(),</span>
<span class="fc" id="L48">            request.getHallId()</span>
<span class="fc" id="L49">        ).orElseThrow(() -&gt; new IllegalArgumentException(&quot;Showtime on &quot; + request.getDate() + &quot; at &quot; + request.getShowtimeTime() + &quot; is not available.&quot;));</span>
        
        // 4. Reserve Seats (The critical transaction)
        try {
<span class="fc" id="L53">            List&lt;Seat&gt; reservedSeats = seatRepository.reserveSeats(</span>
                showtime, 
<span class="fc" id="L55">                request.getSeatIds()</span>
            );
            
            // 5. Create Booking Result (Success)
<span class="fc" id="L59">            return new BookingResult(movie, showtime, reservedSeats); </span>
            
<span class="fc" id="L61">        } catch (SeatUnavailableException e) {</span>
            // Re-throw the explicit infrastructure exception
<span class="fc" id="L63">            throw e; </span>
        }
    }
    
    /**
     * Retrieves all available cinema halls.
     */
    public List&lt;CinemaHall&gt; getAllHalls() {
<span class="nc bnc" id="L71" title="All 2 branches missed.">        if (seatRepository instanceof FileSeatRepository) {</span>
<span class="nc" id="L72">            return ((FileSeatRepository) seatRepository).getAllHalls();</span>
        }
<span class="nc" id="L74">        return List.of(); // Empty list if wrong repository type</span>
    }
    
    /**
     * Retrieves halls of a specific type.
     */
    public List&lt;CinemaHall&gt; getHallsByType(String hallType) {
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (seatRepository instanceof FileSeatRepository) {</span>
<span class="nc" id="L82">            return ((FileSeatRepository) seatRepository).getHallsByType(hallType);</span>
        }
<span class="nc" id="L84">        return List.of();</span>
    }
    
    /**
     * Retrieves seat availability for a specific showtime.
     */
    public List&lt;Seat&gt; getSeatsByShowtime(Movie movie, LocalDate date, String time, int hallId) {
<span class="nc" id="L91">        Showtime showtime = showtimeRepository.findAvailableShowtime(</span>
            movie, date, time, hallId
<span class="nc" id="L93">        ).orElseThrow(() -&gt; new IllegalArgumentException(&quot;Showtime not found&quot;));</span>
        
<span class="nc" id="L95">        return seatRepository.findSeatsByShowtime(showtime);</span>
    }
    
    /**
     * Retrieves a single movie by its ID.
     */
    public Movie getMovieById(int movieId) {
<span class="fc" id="L102">        return movieRepository.findById(movieId)</span>
<span class="fc" id="L103">            .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Movie with ID &quot; + movieId + &quot; not found.&quot;));</span>
    }
    
    /**
     * Retrieves all movies for display.
     */
    public List&lt;Movie&gt; getAvailableMovies() {
<span class="fc" id="L110">        return movieRepository.findAll();</span>
    }
    
    /**
     * Retrieves available dates for a given movie.
     */
    public List&lt;Showtime&gt; getAvailableShowtimeDates(Movie movie) {
<span class="fc" id="L117">        return showtimeRepository.findAvailableDates(movie);</span>
    }

    private void validateBookingRequest(BookingRequest request) {
<span class="fc bfc" id="L121" title="All 4 branches covered.">        if (request.getSeatIds() == null || request.getSeatIds().isEmpty()) {</span>
<span class="fc" id="L122">            throw new IllegalArgumentException(&quot;No seats selected for booking.&quot;);</span>
        }
<span class="fc bfc" id="L124" title="All 2 branches covered.">        if (request.getMovieId() &lt;= 0) {</span>
<span class="fc" id="L125">            throw new IllegalArgumentException(&quot;Invalid movie ID.&quot;);</span>
        }
        
        // Check for duplicate seats in request
<span class="fc" id="L129">        java.util.Set&lt;domain.valueobjects.SeatId&gt; uniqueSeats = new java.util.HashSet&lt;&gt;(request.getSeatIds());</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">        if (uniqueSeats.size() != request.getSeatIds().size()) {</span>
<span class="fc" id="L131">            throw new IllegalArgumentException(&quot;Duplicate seats detected in selection.&quot;);</span>
        }
<span class="fc" id="L133">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>